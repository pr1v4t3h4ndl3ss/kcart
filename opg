local api_key = _G.API_KEY
local vps = _G.VPS or ""

local Players = game:GetService("Players")
local LP = Players.LocalPlayer

local function waitCharacterFullyLoaded()
    local start = os.clock()

    local pcFolder = workspace:WaitForChild("PlayerCharacters")
    local charModel = pcFolder:WaitForChild(LP.Name)

    while os.clock() - start < 15 do
        local characterLoaded = charModel:GetAttribute("characterLoaded")
        local backpackLoaded = charModel:GetAttribute("backpackLoaded")

        if characterLoaded == true and backpackLoaded == true then
            return
        end

        task.wait(0.1)
    end
end

waitCharacterFullyLoaded()

task.wait(5)

local http = request or http_request
if not http then return end

local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")

local function getPSCode()
    local ok, res = pcall(function()
        local code = LP.PlayerGui.Settings.Main.Code
        return code and code.Text or "Public Server"
    end)
    return ok and res or "Public Server"
end

local function getStats()
    local ok, res = pcall(function()
        local statsFolder = game:GetService("ReplicatedStorage"):FindFirstChild("Stats" .. LP.Name)
        local stats = statsFolder and statsFolder:FindFirstChild("Stats")
        local level = stats and stats:FindFirstChild("Level")
        local peli = stats and stats:FindFirstChild("Peli")

        return {
            level = level and level.Value or 0,
            peli = peli and peli.Value or 0
        }
    end)

    return ok and res or { level = 0, peli = 0 }
end

local function GetMythicalFruitChestCount()
    local user = game.Players.LocalPlayer.Name
    local statsFolder = game:GetService("ReplicatedStorage"):FindFirstChild("Stats" .. user)
    if not statsFolder then
        return 0
    end

    local invFolder = statsFolder:FindFirstChild("Inventory")
    if not invFolder then
        return 0
    end

    local invValue = invFolder:FindFirstChild("Inventory")
    if not invValue or not invValue:IsA("StringValue") then
        return 0
    end

    local ok, data = pcall(function()
        return game:GetService("HttpService"):JSONDecode(invValue.Value)
    end)

    if not ok or type(data) ~= "table" then
        return 0
    end

    local count = data["Mythical Fruit Chest"]
    if type(count) == "number" and count > 0 then
        return count
    end

    return 0
end

local function GetLegendaryFishBaitCount()
    local user = LP.Name
    local statsFolder = game:GetService("ReplicatedStorage"):FindFirstChild("Stats" .. user)
    if not statsFolder then
        return 0
    end

    local invFolder = statsFolder:FindFirstChild("Inventory")
    if not invFolder then
        return 0
    end

    local invValue = invFolder:FindFirstChild("Inventory")
    if not invValue or not invValue:IsA("StringValue") then
        return 0
    end

    local ok, data = pcall(function()
        return HttpService:JSONDecode(invValue.Value)
    end)

    if not ok or type(data) ~= "table" then
        return 0
    end

    local count = data["Legendary Fish Bait"]
    if type(count) == "number" and count > 0 then
        return count
    end

    return 0
end

local function getFullInventory()
    local user = LP.Name
    local statsFolder = game:GetService("ReplicatedStorage"):FindFirstChild("Stats" .. user)
    if not statsFolder then
        return {}
    end

    local invFolder = statsFolder:FindFirstChild("Inventory")
    if not invFolder then
        return {}
    end

    local invValue = invFolder:FindFirstChild("Inventory")
    if not invValue or not invValue:IsA("StringValue") then
        return {}
    end

    local ok, data = pcall(function()
        return HttpService:JSONDecode(invValue.Value)
    end)

    if not ok or type(data) ~= "table" then
        return {}
    end

    local result = {}
    for itemName, count in pairs(data) do
        if type(count) == "number" and count > 0 then
            result[itemName] = count
        end
    end

    return result
end

local function getFPS()
    local ok, fps = pcall(function()
        return game:GetService("Players").LocalPlayer.PlayerGui.Display.FPS.Text
    end)
    return ok and fps or "N/A"
end

local function getPing()
    local ok, text = pcall(function()
        return game:GetService("Players").LocalPlayer.PlayerGui.Display.Region.ContentText
    end)

    if not ok or type(text) ~= "string" then
        return "N/A"
    end

    local ping = text:match("^(.-)%s*Ping")
    return ping or text
end

local function getAllPlayersInServer()
    local result = {}

    for _, player in ipairs(Players:GetPlayers()) do
        local level = 0

        local statsFolder = game:GetService("ReplicatedStorage"):FindFirstChild("Stats" .. player.Name)
        if statsFolder then
            local stats = statsFolder:FindFirstChild("Stats")
            if stats then
                local lv = stats:FindFirstChild("Level")
                if lv then
                    level = lv.Value
                end
            end
        end

        result[#result + 1] = {
            username = player.Name,
            level = level
        }
    end

    return result
end

local NPC_FOLDER = workspace:WaitForChild("NPCs")
local NPC_NAME = "Juzo the Diamondback"

local juzoEventHistory = {}
local juzoLocked = false

local function handleJuzo(model)
    if juzoLocked then return end
    if not model:IsA("Model") then return end
    if model.Name ~= NPC_NAME then return end

    local hum = model:FindFirstChildOfClass("Humanoid")
    if not hum then return end

    juzoLocked = true
    
    table.insert(juzoEventHistory, 1, {
        type = "spawn",
        time = os.time(),
        count = math.floor(#juzoEventHistory / 2) + 1
    })

    task.spawn(function()
        while hum.Health > 0 do
            task.wait(1)
        end

        table.insert(juzoEventHistory, 1, {
            type = "dead",
            time = os.time(),
            count = math.floor(#juzoEventHistory / 2) + 1
        })
        
        if #juzoEventHistory > 100 then
            table.remove(juzoEventHistory, 101)
        end
                
        task.wait(2)
        juzoLocked = false
    end)
end

for _, npc in ipairs(NPC_FOLDER:GetChildren()) do
    handleJuzo(npc)
end

NPC_FOLDER.ChildAdded:Connect(function(child)
    handleJuzo(child)
end)

local lastSend = 0

RunService.Heartbeat:Connect(function()
    local now = os.clock()
    if now - lastSend < 5 then return end
    lastSend = now

    local stats = getStats()
    local serverPlayers = getAllPlayersInServer()

    http({
        Url = "https://d10c-2405-4800-5715-c5e0-ec60-fb4c-b1e6-ef07.ngrok-free.app/track",
        Method = "POST",
        Headers = {
            ["Content-Type"] = "application/json",
            ["x-api-key"] = api_key
        },
        Body = HttpService:JSONEncode({
            username = LP.Name,
            level = stats.level,
            peli = stats.peli,
            mythicalChest = GetMythicalFruitChestCount(),
            legendaryFishBaits = GetLegendaryFishBaitCount(),
            psCode = getPSCode(),
            inventory = getFullInventory(),
            vps = vps,
            fps = getFPS(),
            ping = getPing(),
            serverPlayers = serverPlayers,
            juzoEventHistory = juzoEventHistory
        })
    })
end)
